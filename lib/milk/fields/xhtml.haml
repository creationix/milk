!!! xml
!!! 1.1
%html{:xmlns =>"http://www.w3.org/1999/xhtml"}
  %head
    %title&= "Editing \"#{@pagename}\""
    %style{:type=>"text/css"}
      :sass
        body, html
          :border 0
          :margin 0
          :padding 0
        body.busy
          :cursor busy
        div.component
          &:hover
            :border 10px solid #08f
        #admin-title
          :position absolute
          :margin 0
          :top 5px
          :left 10px
          :line-height 1em
          :font-size 20px
          :font-family monaco,monospace
          
        #toolbar
          :position absolute
          :left 0
          :bottom 0
          :right 0
          :padding 3px
          .toolitem
            :font-size 12px
            :cursor pointer
            :line-height 1em
            :padding 2px 5px 2px 2px
            .ui-icon
              :float left
              :line-height 1em
        #frame
          :position absolute
          :top 0px
          :left 0px
          :right 0px
          :bottom 0px
        #left
          :font-size 11px
          :position absolute
          :top 0px
          :left 0px
          :width 250px
          :bottom 0px
          h4
            :font-size 14px
          h3
            :font-size 13px
        #divider
          :position absolute
          :top 0px
          :left 250px
          :width 5px
          :bottom 0px
        
        #fields
          :position absolute
          :top 0px
          :bottom 35px
          :overflow auto
          :left 0px
          :right 0
          .ui-accordion-content
            :padding 10px
            h4
              :margin 0
            .field-content
              :margin-bottom 10px
              input
                :width 95%
                :padding 2px
              textarea
                :width 100%
                :min-height 330px
              .sprite-select
                .sprite-option
                  :padding 4px
                  :margin 2px
                  :float left
                  :cursor pointer
          
        #preview
          :position absolute
          :top 0px
          :left 255px
          :right 0
          :width auto
          :bottom 0px
          :overflow auto
          
          
    %link{ :rel => "shortcut icon", :href => "/favicon.ico", :type => "image/x-icon"}/
    %link{ :href => "/skin/jquery-ui-1.7.2.custom.css", :media => "screen", :rel => "stylesheet", :type => "text/css" }/
    %link{ :href => "/style/style.css", :media => "screen", :rel => "stylesheet", :type => "text/css" }/
    %script{:src=>"/js/jquery-1.3.2.min.js", :type=>"text/javascript"}
    %script{:src=>"/js/jquery.json-1.3.min.js", :type=>"text/javascript"}
    %script{:src=>"/js/jquery-ui-1.7.2.custom.min.js", :type=>"text/javascript"}
  %body
    #frame
      #left
        .ui-widget-overlay
        %form#fields{:method => "post", :action => "/"+@pagename}
          %h3
            %a{:href => "#"} Page Settings
          %div
            %input{:type=>"hidden", :name=>"class", :value=>self.class.to_s}
            -to_yaml_properties.each do |name|
              - next if name == :@components
              - fieldname = name.to_s.sub('@','')
              .field
                %h4= fieldname.capitalize + ":"
                .field-content
                  %input{:type=>"text", :name=>fieldname, :value=>instance_variable_get(name)}
          -@components.each_with_index do |component, i|
            = component.edit("components:#{i}")
        #toolbar{:class=>'ui-widget ui-widget-header'}
          %button#save_button.toolitem{:title=>'Save changes and go to live page.'}
            %span{:class=>'ui-icon ui-icon-disk'}
            Save
          %button#cancel_button.toolitem{:title=>'Cancel changes and go to live page.'}
            %span{:class=>'ui-icon ui-icon-cancel'}
            Cancel
          %button#logout_button.toolitem{:title=>'Cancel changes and logout and go to live page.'}
            %span{:class=>'ui-icon ui-icon-locked'}
            Logout
      #preview
        = preview
      #divider.ui-widget-header
      
    :javascript
      function on_click_sprite(e)
      {
        // Look up some useful variables
        var current = e.currentTarget;
        var sprite_select = $(current.parentNode);
        var peers = $(".sprite-option", sprite_select);
        var hidden_input = $('input', sprite_select)[0];
        var inner_span = $('span', current)[0];

        // Set the value on the hidden input
        hidden_input.value = inner_span.title;

        // Move the highlight        
        peers.removeClass('ui-state-highlight');
        $(current).addClass('ui-state-highlight');
        update_preview(50);
      }
      
      function jsonify(form)
      {
        var data = {}
        $("input, textarea, select", form).each(function (i, field){
          var parts = field.name.split(':');
          var root = data;
          var part = parts[0];
          var numeric_regexp = /[0-9]+/;
          for(i=0;i<parts.length-1;i++)
          {
            if (!root[part])
            {
              if (numeric_regexp.test(part))
                root[part]={};
              else
                root[part]=[];
            }
            root = root[part];
            part = parts[i + 1];
          }
          root[part] = field.value;
        });
        return $.toJSON(data);
      }
      
      function do_update_preview()
      {
        var preview = $("#preview");
        $("body").addClass("busy")
        $.ajax({
          type: "POST",
          url: $("form")[0].action,
          contentType: "application/json",
          data: jsonify($("form")[0]),
          success: function(msg){
            preview.html(msg);
            $("body").removeClass("busy")
          }
        });
      }
      
      function update_preview(timeout)
      {
        clearTimeout(window.preview_timeout);
        window.preview_timeout = setTimeout(do_update_preview, timeout);
      }
      
      
      $(function() {
        $("#left").resizable({handles: "e", resize: function(event, ui) {
          $("#divider").css("left", ui.size.width);
          $("#preview").css("left", ui.size.width+5);
        }});
        $(".sub-fields").accordion({
          collapsible: true,
          autoHeight: false,
          active: false
        });
        var sections = $("#fields").accordion({
          autoHeight: false
        });
        
        $(".sprite-option").click(on_click_sprite);
       $(".toolitem, .sprite-option")
        .addClass("ui-state-default ui-corner-all")
        .hover(
          function() { $(this).addClass('ui-state-hover'); },
          function() { $(this).removeClass('ui-state-hover'); }
        );
        $("#fields select, #fields input, #fields textarea").change(function(){
          update_preview(100);
        });
        $("#fields select, #fields input, #fields textarea").keyup(function(){
          update_preview(1000);
        });
        $("#save_button").click(function(){
          $.ajax({
            type: "PUT",
            url: $("form")[0].action,
            contentType: "application/json",
            data: jsonify($("form")[0]),
            success: function(msg){
              window.location = $("form")[0].action.replace('https://', 'http://');
            }
          });
        });
        
        $("#cancel_button").click(function(){
          window.location = $("form")[0].action.replace('https://', 'http://');
        });
        $("#logout_button").click(function(){
          window.location = "/logout?dest="+$("form")[0].action.replace('https://', 'http://');
        });
        
      });


